<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectrum Outfitters PPF Pricing Calculator - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calculator-section { background-color: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; }
        .results-section { background-color: #eff6ff; padding: 1.5rem; border-radius: 0.5rem; }
        .price-display { background-color: #dcfce7; padding: 1rem; border-radius: 0.5rem; text-align: center; }
        .floor-price { background-color: #fef2f2; border: 1px solid #fecaca; padding: 0.75rem; border-radius: 0.5rem; }
        .cost-breakdown { background-color: white; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; }
        .service-info { background-color: #f0f9ff; border: 1px solid #bae6fd; padding: 0.75rem; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üßÆ Spectrum Outfitters PPF Pricing Calculator</h1>
            <p class="text-gray-600">Professional Paint Protection Film Pricing Tool with Service Types</p>
            
            <!-- Settings Button -->
            <button id="settingsBtn" class="absolute top-0 right-0 p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                ‚öôÔ∏è Settings
            </button>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Vehicle & Materials -->
            <div class="calculator-section">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üöó Vehicle & Materials
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vehicle Type</label>
                        <select id="vehicleType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="car">Car/Sedan</option>
                            <option value="coupe">Coupe/Sports Car</option>
                            <option value="truck">Truck/Pickup</option>
                            <option value="suv">SUV/Large Vehicle</option>
                            <option value="van">Van/Commercial</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service Type</label>
                        <select id="serviceType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="full-front">Full Front (Hood, Fenders, Bumper, Mirrors)</option>
                            <option value="track-pack">Track Pack (Hood, Fenders, Mirrors)</option>
                            <option value="full-vehicle">Full Vehicle (Complete Coverage)</option>
                            <option value="replacement-parts">Replacement Parts (Individual Panels)</option>
                            <option value="custom-service">Custom Service</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Auto-adjusts materials and labor</p>
                    </div>

                    <!-- Service Information Display -->
                    <div class="service-info" id="serviceInfo">
                        <div class="text-sm font-medium text-blue-800 mb-1" id="serviceLabel">Full Front</div>
                        <div class="text-xs text-blue-600" id="serviceDescription">Hood, front fenders, front bumper, mirrors, headlights</div>
                        <div class="text-xs text-blue-600 mt-1">Estimated: <span id="serviceEstimate">0.7 rolls, 1.5 days</span></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PPF Type</label>
                        <select id="ppfTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="gloss">Gloss PPF ($800/roll)</option>
                            <option value="stealth">Stealth PPF ($1,100/roll)</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1" id="ppfDescription">Standard gloss finish</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Rolls Needed</label>
                        <input type="number" id="rollsNeeded" value="0.7" min="0" step="0.1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">1 roll typically covers a regular coupe/sedan</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Days Needed</label>
                        <input type="number" id="daysNeeded" value="1.5" min="0" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Daily overhead: $300 (fixed)</p>
                    </div>
                </div>
            </div>

            <!-- Labor & Quoting -->
            <div class="calculator-section">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                    üí∞ Labor & Quoting
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Labor Type</label>
                        <div class="flex gap-2">
                            <button id="contractedBtn" class="flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white">Contracted</button>
                            <button id="hourlyBtn" class="flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300">Hourly</button>
                        </div>
                    </div>

                    <div id="contractedInput">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contracted Cost</label>
                        <input type="number" id="contractedCost" value="2000" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div id="hourlyInput" class="hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Hourly Rate</label>
                                <input type="number" id="hourlyRate" value="75" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Hours</label>
                                <input type="number" id="hoursNeeded" value="26" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Customer Type</label>
                        <div class="flex gap-2">
                            <button id="customerBtn" class="flex-1 px-3 py-2 text-sm rounded bg-green-600 text-white">Customer</button>
                            <button id="dealerBtn" class="flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300">Dealer (-15%)</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sales Type</label>
                        <div class="flex gap-2">
                            <button id="inboundBtn" class="flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white">Inbound (3-5%)</button>
                            <button id="outboundBtn" class="flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300">Outbound (6-8%)</button>
                            <button id="directBtn" class="flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300">Direct (0%)</button>
                        </div>
                    </div>

                    <div id="commissionInput" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Commission Rate</label>
                        <select id="commissionRate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="0.03">3%</option>
                            <option value="0.04">4%</option>
                            <option value="0.05">5%</option>
                            <option value="0.06">6%</option>
                            <option value="0.07">7%</option>
                            <option value="0.08">8%</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <input type="checkbox" id="dealerVolume" class="mr-2">
                            Dealer Volume Job (Higher ticket, adjust margins)
                        </label>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rounding</label>
                            <select id="roundStep" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="0" selected>None</option>
                                <option value="25">$25 (up)</option>
                                <option value="50">$50 (up)</option>
                                <option value="100">$100 (up)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tax %</label>
                            <input type="number" id="taxPct" value="0" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Deposit %</label>
                            <input type="number" id="depositPct" value="0" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div class="results-section">
                <h2 class="text-xl font-semibold mb-4 text-blue-800">Quote Summary</h2>

                <div class="space-y-4">
                    <!-- Customer Price -->
                    <div class="price-display">
                        <div class="text-sm text-green-700 mb-1" id="customerTypeLabel">Customer Price</div>
                        <div class="text-3xl font-bold text-green-800" id="finalPrice">$0</div>
                        <div class="text-xs text-green-600 mt-1" id="marginDisplay">0.0% margin</div>
                    </div>

                    <!-- Floor Price -->
                    <div class="floor-price">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-sm font-medium text-red-800">Floor Price (Do Not Go Below)</div>
                                <div class="text-xs text-red-600" id="marginRequirement">30% minimum margin required</div>
                                <div class="text-xs text-blue-600" id="dealerVolumeIndicator" style="display: none;">Dealer Volume: 25.5% margin floor</div>
                            </div>
                            <div class="text-xl font-bold text-red-800" id="baselinePrice">$0</div>
                        </div>
                        <div class="mt-2 text-xs text-gray-600" id="negotiationRoom"></div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="cost-breakdown">
                        <div class="text-sm font-medium text-gray-700 mb-2">Cost Breakdown</div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600" id="materialsLabel">Materials (0.7 rolls)</span>
                                <span id="materialsCost">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Labor</span>
                                <span id="laborCost">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" id="overheadLabel">Overhead (1.5 days)</span>
                                <span id="overheadCost">$0</span>
                            </div>
                            <div class="flex justify-between font-medium border-t pt-1">
                                <span>Total Cost</span>
                                <span id="totalCost">$0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Commission & Margin Breakdown (Internal Only) -->
                    <div class="cost-breakdown bg-blue-50 border-blue-200">
                        <div class="text-sm font-medium text-blue-800 mb-2">üí∞ Internal Breakdown</div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Gross Profit</span>
                                <span id="grossProfit">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Commission</span>
                                <span id="commissionAmount">$0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Net Profit</span>
                                <span id="netProfit">$0</span>
                            </div>
                            <div class="flex justify-between font-medium border-t pt-1">
                                <span>Gross Margin</span>
                                <span id="grossMargin">0.0%</span>
                            </div>
                            <div class="flex justify-between font-medium">
                                <span>Net Margin (after commission)</span>
                                <span id="netMargin">0.0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Margin Warnings -->
                    <div id="marginWarning" class="hidden">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                            <div class="text-sm font-medium text-yellow-800">‚ö†Ô∏è Margin Warning</div>
                            <div class="text-xs text-yellow-700 mt-1" id="warningMessage"></div>
                        </div>
                    </div>

                    <!-- Tax & Deposit -->
                    <div class="cost-breakdown" id="taxDepositSection" style="display: none;">
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal</span>
                                <span id="subtotal">$0</span>
                            </div>
                            <div class="flex justify-between" id="taxRow" style="display: none;">
                                <span class="text-gray-600" id="taxLabel">Tax (0%)</span>
                                <span id="taxAmount">$0</span>
                            </div>
                            <div class="flex justify-between font-medium border-t pt-1" id="totalWithTaxRow" style="display: none;">
                                <span>Total with Tax</span>
                                <span id="totalWithTax">$0</span>
                            </div>
                            <div class="flex justify-between text-blue-600 font-medium" id="depositRow" style="display: none;">
                                <span id="depositLabel">Deposit (50%)</span>
                                <span id="depositAmount">$0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Type Guide -->
        <div class="mt-8 bg-gray-50 p-6 rounded-lg">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">Service Type Guide</h3>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="bg-white p-4 rounded border">
                    <div class="font-medium text-blue-800 mb-2">Full Front</div>
                    <div class="text-gray-600 mb-1">Hood, front fenders, front bumper, mirrors, headlights</div>
                    <div class="text-gray-500">0.7 rolls, 1.5 days</div>
                </div>
                <div class="bg-white p-4 rounded border">
                    <div class="font-medium text-green-800 mb-2">Track Pack</div>
                    <div class="text-gray-600 mb-1">Hood, front fenders, mirrors</div>
                    <div class="text-gray-500">0.6 rolls, 1.25 days</div>
                </div>
                <div class="bg-white p-4 rounded border">
                    <div class="font-medium text-purple-800 mb-2">Full Vehicle</div>
                    <div class="text-gray-600 mb-1">Complete coverage including roof, doors, rear</div>
                    <div class="text-gray-500">2.5 rolls, 4 days</div>
                </div>
                <div class="bg-white p-4 rounded border">
                    <div class="font-medium text-orange-800 mb-2">Replacement Parts</div>
                    <div class="text-gray-600 mb-1">Individual panels like hood only, fender only</div>
                    <div class="text-gray-500">0.3 rolls, 0.75 days</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 text-center space-x-4">
            <button id="copyBtn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                üìã Copy Quote
            </button>
            <button id="resetBtn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                üîÑ Reset
            </button>
        </div>

        <!-- Professional Footer -->
        <div class="mt-12 border-t border-gray-200 pt-8">
            <div class="text-center">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold text-sm">S</span>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800">Spectrum Outfitters</h3>
                </div>
                <p class="text-gray-600 mb-2">Professional Paint Protection Film Services</p>
                <div class="text-sm text-gray-500 space-y-1">
                    <p>PPF Installation ‚Ä¢ Vehicle Protection ‚Ä¢ Professional Service</p>
                    <p class="font-medium text-blue-600">spectrumoutfitters.com</p>
                </div>
                <div class="mt-4 mb-4">
                    <a href="/" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <span>üîß</span>
                        <span>View All Tools</span>
                    </a>
                </div>
                <div class="text-xs text-gray-400">
                    <p>¬© 2025 Spectrum Outfitters. All rights reserved.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Popup -->
    <div id="settingsPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">PPF Calculator Settings</h3>
                        <button id="closeSettings" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- PPF Materials Configuration -->
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">PPF Materials & Brands</h4>
                            <div class="space-y-4">
                                <div id="ppfMaterialsList">
                                    <!-- PPF materials will be dynamically added here -->
                                </div>
                                <button id="addPpfMaterial" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    + Add New PPF Material
                                </button>
                            </div>
                        </div>

                        <!-- Commission Settings -->
                        <div>
                            <h4 class="font-medium text-gray-800 mb-4">Commission & Pricing</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Commission Rate</label>
                                    <select id="defaultCommissionRate" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="0.04">4% (Inbound)</option>
                                        <option value="0.07">7% (Outbound)</option>
                                        <option value="0">0% (Direct)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Default Rounding</label>
                                    <select id="defaultRounding" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                        <option value="0" selected>None</option>
                                        <option value="25">$25</option>
                                        <option value="50">$50</option>
                                        <option value="100">$100</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-between items-center">
                        <div class="flex space-x-3">
                            <button id="exportSettings" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                üì§ Export Settings
                            </button>
                            <button id="importSettings" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                                üì• Import Settings
                            </button>
                        </div>
                        <div class="flex space-x-3">
                            <button id="saveSettings" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Settings</button>
                            <button id="cancelSettings" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const BASELINE_MARGIN = 0.30;
        const RETAIL_MARKUP = 0.30;
        const DEALER_DISCOUNT = 0.15;

        // PPF Materials Configuration
        let ppfMaterials = [
            { id: 'gloss', name: 'Gloss PPF', cost: 800, description: 'Standard gloss finish' },
            { id: 'stealth', name: 'Stealth PPF', cost: 1100, description: 'Matte finish' }
        ];

        // Load settings from localStorage on startup
        function loadSettingsFromStorage() {
            const savedMaterials = localStorage.getItem('spectrumPpfMaterials');
            if (savedMaterials) {
                try {
                    ppfMaterials = JSON.parse(savedMaterials);
                } catch (e) {
                    console.log('Using default PPF materials');
                }
            }
        }

        // Save settings to localStorage
        function saveSettingsToStorage() {
            localStorage.setItem('spectrumPpfMaterials', JSON.stringify(ppfMaterials));
        }
        const DAILY_OVERHEAD = 300;

        // Vehicle estimates
        const vehicleEstimates = {
            car: { rolls: 1, days: 5, label: 'Car/Sedan' },
            coupe: { rolls: 1, days: 4, label: 'Coupe/Sports Car' },
            truck: { rolls: 2, days: 7, label: 'Truck/Pickup' },
            suv: { rolls: 2, days: 6, label: 'SUV/Large Vehicle' },
            van: { rolls: 2, days: 8, label: 'Van/Commercial' },
            custom: { rolls: 1, days: 5, label: 'Custom' }
        };

        // Service type estimates (rolls and days)
        const serviceEstimates = {
            'full-front': { 
                rolls: 0.7, 
                days: 1.5, 
                label: 'Full Front',
                description: 'Hood, front fenders, front bumper, mirrors, headlights'
            },
            'track-pack': { 
                rolls: 0.6, 
                days: 1.25, 
                label: 'Track Pack',
                description: 'Hood, front fenders, mirrors'
            },
            'full-vehicle': { 
                rolls: 2.5, 
                days: 4, 
                label: 'Full Vehicle',
                description: 'Complete coverage including roof, doors, rear'
            },
            'replacement-parts': { 
                rolls: 0.3, 
                days: 0.75, 
                label: 'Replacement Parts',
                description: 'Individual panels like hood only, fender only'
            },
            'custom-service': { 
                rolls: 1, 
                days: 5, 
                label: 'Custom Service',
                description: 'Manual input required'
            }
        };

        // State
        let currentState = {
            vehicleType: 'car',
            serviceType: 'full-front',
            ppfType: 'gloss',
            laborType: 'contracted',
            customerType: 'customer',
            roundStep: 0,
            salesType: 'inbound',
            commissionRate: 0.04,
            dealerVolume: false
        };

        // Utility functions
        function usd(n) {
            if (n === undefined || n === null || isNaN(n)) return '$0';
            return n.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
        }

        function pct(f) {
            if (!isFinite(f)) return '0.0%';
            return `${(f * 100).toFixed(1)}%`;
        }

        function roundUpTo(n, step) {
            if (!step || step <= 0) return Math.round(n);
            return Math.ceil(n / step) * step;
        }

        // Check margin warnings
        function checkMarginWarnings(netMargin, grossProfit, commissionAmount) {
            const warningDiv = document.getElementById('marginWarning');
            const warningMessage = document.getElementById('warningMessage');
            
            // Hide warning by default
            warningDiv.classList.add('hidden');
            
            // Determine effective margin floor based on dealer volume
            const effectiveMarginFloor = currentState.dealerVolume && currentState.customerType === 'dealer' 
                ? 0.255  // 30% * 0.85 = 25.5% for dealer volume jobs
                : 0.30;  // Standard 30% floor
            
            // Check for warnings
            if (netMargin < effectiveMarginFloor) {
                warningDiv.classList.remove('hidden');
                warningDiv.className = 'bg-red-50 border border-red-200 rounded-md p-3';
                
                if (netMargin < effectiveMarginFloor * 0.85) {
                    warningMessage.innerHTML = `
                        <strong>Critical:</strong> Net margin (${(netMargin * 100).toFixed(1)}%) is below ${(effectiveMarginFloor * 100).toFixed(1)}% floor!<br>
                        <strong>Actions needed:</strong><br>
                        ‚Ä¢ Increase labor rate by $${Math.ceil(commissionAmount / effectiveMarginFloor)}<br>
                        ‚Ä¢ Add premium service options<br>
                        ‚Ä¢ Bundle with additional services<br>
                        ‚Ä¢ ${currentState.dealerVolume ? 'Consider standard dealer pricing (uncheck volume)' : 'Consider dealer volume pricing'}
                    `;
                } else {
                    warningMessage.innerHTML = `
                        <strong>Warning:</strong> Net margin (${(netMargin * 100).toFixed(1)}%) is close to ${(effectiveMarginFloor * 100).toFixed(1)}% floor<br>
                        <strong>Consider:</strong> Increasing price or reducing costs
                    `;
                }
            } else if (netMargin < (effectiveMarginFloor + 0.05)) {
                warningDiv.classList.remove('hidden');
                warningDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-md p-3';
                warningMessage.innerHTML = `
                    <strong>Notice:</strong> Net margin (${(netMargin * 100).toFixed(1)}%) is above floor but below ${((effectiveMarginFloor + 0.05) * 100).toFixed(1)}%<br>
                    <strong>Recommendation:</strong> Consider price optimization
                `;
            }
        }

        // Update commission input visibility and rates
        function updateCommissionInput() {
            const commissionInput = document.getElementById('commissionInput');
            const commissionRate = document.getElementById('commissionRate');
            
            if (currentState.salesType === 'direct') {
                commissionInput.classList.add('hidden');
                currentState.commissionRate = 0;
            } else {
                commissionInput.classList.remove('hidden');
                
                // Set appropriate commission rates based on sales type
                if (currentState.salesType === 'inbound') {
                    // Filter to show only 3-5% options
                    Array.from(commissionRate.options).forEach(option => {
                        const rate = parseFloat(option.value);
                        option.style.display = (rate >= 0.03 && rate <= 0.05) ? '' : 'none';
                    });
                    // Set default to 4% for inbound
                    currentState.commissionRate = 0.04;
                    commissionRate.value = '0.04';
                } else if (currentState.salesType === 'outbound') {
                    // Filter to show only 6-8% options
                    Array.from(commissionRate.options).forEach(option => {
                        const rate = parseFloat(option.value);
                        option.style.display = (rate >= 0.06 && rate <= 0.08) ? '' : 'none';
                    });
                    // Set default to 7% for outbound
                    currentState.commissionRate = 0.07;
                    commissionRate.value = '0.07';
                }
            }
        }

        // Settings popup functions
        function openSettings() {
            document.getElementById('settingsPopup').classList.remove('hidden');
            renderPpfMaterials();
            loadSettingsToForm();
        }

        function closeSettings() {
            document.getElementById('settingsPopup').classList.add('hidden');
        }

        function renderPpfMaterials() {
            const container = document.getElementById('ppfMaterialsList');
            container.innerHTML = '';
            
            ppfMaterials.forEach((material, index) => {
                const materialDiv = document.createElement('div');
                materialDiv.className = 'border border-gray-300 rounded p-3 bg-gray-50';
                materialDiv.innerHTML = `
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <input type="text" placeholder="Brand/Name" value="${material.name}" 
                               class="px-2 py-1 border border-gray-300 rounded text-sm" 
                               onchange="updatePpfMaterial(${index}, 'name', this.value)">
                        <input type="number" placeholder="Cost per roll" value="${material.cost}" 
                               class="px-2 py-1 border border-gray-300 rounded text-sm" 
                               onchange="updatePpfMaterial(${index}, 'cost', this.value)">
                        <button onclick="removePpfMaterial(${index})" 
                                class="px-2 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                            Remove
                        </button>
                    </div>
                    <input type="text" placeholder="Description" value="${material.description}" 
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm" 
                           onchange="updatePpfMaterial(${index}, 'description', this.value)">
                `;
                container.appendChild(materialDiv);
            });
        }

        function updatePpfMaterial(index, field, value) {
            if (field === 'cost') {
                ppfMaterials[index][field] = parseFloat(value) || 0;
            } else {
                ppfMaterials[index][field] = value;
            }
            // Auto-save when materials are updated
            saveSettingsToStorage();
        }

        function removePpfMaterial(index) {
            if (ppfMaterials.length > 1) {
                ppfMaterials.splice(index, 1);
                renderPpfMaterials();
                updatePpfTypeDropdown();
                // Auto-save when materials are removed
                saveSettingsToStorage();
            }
        }

        function addPpfMaterial() {
            const newMaterial = {
                id: 'custom_' + Date.now(),
                name: 'New PPF',
                cost: 800,
                description: 'Custom PPF material'
            };
            ppfMaterials.push(newMaterial);
            renderPpfMaterials();
            updatePpfTypeDropdown();
            // Auto-save when materials are added
            saveSettingsToStorage();
        }

        function updatePpfTypeDropdown() {
            // Update the PPF type dropdown to reflect the current materials
            const select = document.getElementById('ppfTypeSelect');
            const description = document.getElementById('ppfDescription');
            
            // Store current selection
            const currentValue = select.value;
            
            // Clear existing options
            select.innerHTML = '';
            
            // Add new options based on configured materials
            ppfMaterials.forEach((material, index) => {
                const option = document.createElement('option');
                option.value = material.id;
                option.textContent = `${material.name} ($${material.cost}/roll)`;
                select.appendChild(option);
            });
            
            // Restore selection if possible, otherwise select first
            if (ppfMaterials.find(m => m.id === currentValue)) {
                select.value = currentValue;
            } else if (ppfMaterials.length > 0) {
                select.value = ppfMaterials[0].id;
                currentState.ppfType = ppfMaterials[0].id;
            }
            
            // Update description
            const selectedMaterial = ppfMaterials.find(m => m.id === select.value);
            if (selectedMaterial) {
                description.textContent = selectedMaterial.description;
            }
        }

        function saveSettings() {
            // Save PPF materials and other settings
            // For now, we'll just close the popup
            // In a real app, you'd save to localStorage or a database
            closeSettings();
            updatePpfTypeDropdown();
            calculateResults();
        }

        function loadSettingsToForm() {
            // Load current settings into the form
            document.getElementById('defaultCommissionRate').value = currentState.commissionRate;
            document.getElementById('defaultRounding').value = currentState.roundStep;
        }

        // Export settings to JSON file
        function exportSettings() {
            const settings = {
                ppfMaterials: ppfMaterials,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `spectrum-ppf-settings-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Import settings from JSON file
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            if (settings.ppfMaterials && Array.isArray(settings.ppfMaterials)) {
                                ppfMaterials = settings.ppfMaterials;
                                renderPpfMaterials();
                                updatePpfTypeDropdown();
                                saveSettingsToStorage();
                                alert('Settings imported successfully!');
                            } else {
                                alert('Invalid settings file format');
                            }
                        } catch (error) {
                            alert('Error reading settings file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        // Update service info display
        function updateServiceInfo() {
            const serviceType = currentState.serviceType;
            const estimates = serviceEstimates[serviceType];
            
            document.getElementById('serviceLabel').textContent = estimates.label;
            document.getElementById('serviceDescription').textContent = estimates.description;
            document.getElementById('serviceEstimate').textContent = `${estimates.rolls} rolls, ${estimates.days} days`;
        }

        // Calculate results
        function calculateResults() {
            const rollsNeeded = parseFloat(document.getElementById('rollsNeeded').value) || 0;
            const daysNeeded = parseFloat(document.getElementById('daysNeeded').value) || 0;
            const contractedCost = parseInt(document.getElementById('contractedCost').value) || 0;
            const hourlyRate = parseInt(document.getElementById('hourlyRate').value) || 0;
            const hoursNeeded = parseInt(document.getElementById('hoursNeeded').value) || 0;
            const taxPct = parseFloat(document.getElementById('taxPct').value) || 0;
            const depositPct = parseFloat(document.getElementById('depositPct').value) || 0;

            // Material cost - use dynamic PPF materials
            const selectedMaterial = ppfMaterials.find(m => m.id === currentState.ppfType) || ppfMaterials[0];
            const materialCostPerRoll = selectedMaterial.cost;
            const materialCost = rollsNeeded * materialCostPerRoll;

            // Labor cost
            const laborCost = currentState.laborType === 'contracted' ? contractedCost : (hourlyRate * hoursNeeded);

            // Daily overhead
            const dailyLaborCost = daysNeeded * DAILY_OVERHEAD;
            const totalCost = materialCost + laborCost + dailyLaborCost;

            // Pricing tiers with dealer volume adjustment
            const effectiveMargin = currentState.dealerVolume && currentState.customerType === 'dealer' 
                ? BASELINE_MARGIN * 0.85  // Allow 15% lower margin for dealer volume jobs
                : BASELINE_MARGIN;
            
            const baselinePrice = totalCost / (1 - effectiveMargin);
            const retailPrice = baselinePrice * (1 + RETAIL_MARKUP);
            const dealerPrice = retailPrice * (1 - DEALER_DISCOUNT);

            // Final price
            const candidate = currentState.customerType === 'dealer' ? dealerPrice : retailPrice;
            const floorAppliedPrice = Math.max(candidate, baselinePrice);
            const rounded = roundUpTo(floorAppliedPrice, currentState.roundStep);

            // Tax and deposit
            const taxAmount = rounded * (taxPct / 100);
            const totalWithTax = rounded + taxAmount;
            const depositAmount = totalWithTax * (depositPct / 100);

            // Commission and profit calculations
            const grossProfit = rounded - totalCost;
            const commissionAmount = grossProfit * currentState.commissionRate;
            const netProfit = grossProfit - commissionAmount;
            
            // Margins
            const margin = (sell) => (sell > 0 ? (sell - totalCost) / sell : 0);
            const baselineMargin = margin(baselinePrice);
            const roundedMargin = margin(rounded);
            const netMargin = rounded > 0 ? netProfit / rounded : 0;

            // Check margin warnings
            checkMarginWarnings(netMargin, grossProfit, commissionAmount);

            // Update display
            updateDisplay({
                materialCost,
                laborCost,
                dailyLaborCost,
                totalCost,
                baselinePrice,
                rounded,
                roundedMargin,
                netMargin,
                grossProfit,
                commissionAmount,
                netProfit,
                taxAmount,
                totalWithTax,
                depositAmount,
                rollsNeeded,
                daysNeeded,
                taxPct,
                depositPct
            });
        }

        // Update display
        function updateDisplay(results) {
            document.getElementById('finalPrice').textContent = usd(results.rounded);
            document.getElementById('marginDisplay').textContent = pct(results.roundedMargin) + ' margin';
            document.getElementById('baselinePrice').textContent = usd(results.baselinePrice);
            document.getElementById('materialsCost').textContent = usd(results.materialCost);
            document.getElementById('laborCost').textContent = usd(results.laborCost);
            document.getElementById('overheadCost').textContent = usd(results.dailyLaborCost);
            document.getElementById('totalCost').textContent = usd(results.totalCost);
            
            // Commission breakdown
            document.getElementById('grossProfit').textContent = usd(results.grossProfit);
            document.getElementById('commissionAmount').textContent = usd(results.commissionAmount);
            document.getElementById('netProfit').textContent = usd(results.netProfit);
            document.getElementById('grossMargin').textContent = pct(results.roundedMargin);
            document.getElementById('netMargin').textContent = pct(results.netMargin);

            // Update labels
            document.getElementById('materialsLabel').textContent = `Materials (${results.rollsNeeded} roll${results.rollsNeeded > 1 ? 's' : ''})`;
            document.getElementById('overheadLabel').textContent = `Overhead (${results.daysNeeded} days)`;
            document.getElementById('customerTypeLabel').textContent = currentState.customerType === 'dealer' ? 'Dealer Price' : 'Customer Price';
            
            // Update dealer volume indicator
            const dealerVolumeIndicator = document.getElementById('dealerVolumeIndicator');
            const marginRequirement = document.getElementById('marginRequirement');
            
            if (currentState.dealerVolume && currentState.customerType === 'dealer') {
                dealerVolumeIndicator.style.display = 'block';
                marginRequirement.textContent = '25.5% minimum margin required (Dealer Volume)';
            } else {
                dealerVolumeIndicator.style.display = 'none';
                marginRequirement.textContent = '30% minimum margin required';
            }

            // Negotiation room
            if (results.rounded > results.baselinePrice) {
                document.getElementById('negotiationRoom').textContent = `Negotiation room: ${usd(results.rounded - results.baselinePrice)}`;
            } else {
                document.getElementById('negotiationRoom').textContent = '';
            }

            // Tax and deposit section
            const taxDepositSection = document.getElementById('taxDepositSection');
            const taxRow = document.getElementById('taxRow');
            const totalWithTaxRow = document.getElementById('totalWithTaxRow');
            const depositRow = document.getElementById('depositRow');

            if (results.taxPct > 0 || results.depositPct > 0) {
                taxDepositSection.style.display = 'block';
                document.getElementById('subtotal').textContent = usd(results.rounded);

                if (results.taxPct > 0) {
                    taxRow.style.display = 'flex';
                    totalWithTaxRow.style.display = 'flex';
                    document.getElementById('taxLabel').textContent = `Tax (${results.taxPct}%)`;
                    document.getElementById('taxAmount').textContent = usd(results.taxAmount);
                    document.getElementById('totalWithTax').textContent = usd(results.totalWithTax);
                } else {
                    taxRow.style.display = 'none';
                    totalWithTaxRow.style.display = 'none';
                }

                if (results.depositPct > 0) {
                    depositRow.style.display = 'flex';
                    document.getElementById('depositLabel').textContent = `Deposit (${results.depositPct}%)`;
                    document.getElementById('depositAmount').textContent = usd(results.depositAmount);
                } else {
                    depositRow.style.display = 'none';
                }
            } else {
                taxDepositSection.style.display = 'none';
            }
        }

        // Event handlers
        function setupEventHandlers() {
            // Vehicle type change
            document.getElementById('vehicleType').addEventListener('change', function() {
                const vehicleType = this.value;
                currentState.vehicleType = vehicleType;
                
                if (vehicleType !== 'custom') {
                    const estimates = vehicleEstimates[vehicleType];
                    // Don't auto-update rolls/days for vehicle type when service type is selected
                    if (currentState.serviceType === 'custom-service') {
                        document.getElementById('rollsNeeded').value = estimates.rolls;
                        document.getElementById('daysNeeded').value = estimates.days;
                    }
                }
                
                calculateResults();
            });

            // Service type change
            document.getElementById('serviceType').addEventListener('change', function() {
                const serviceType = this.value;
                currentState.serviceType = serviceType;
                
                if (serviceType !== 'custom-service') {
                    const estimates = serviceEstimates[serviceType];
                    document.getElementById('rollsNeeded').value = estimates.rolls;
                    document.getElementById('daysNeeded').value = estimates.days;
                }
                
                updateServiceInfo();
                calculateResults();
            });

            // PPF type dropdown
            document.getElementById('ppfTypeSelect').addEventListener('change', function() {
                currentState.ppfType = this.value;
                // Update description
                const selectedMaterial = ppfMaterials.find(m => m.id === this.value);
                if (selectedMaterial) {
                    document.getElementById('ppfDescription').textContent = selectedMaterial.description;
                }
                calculateResults();
            });



            // Labor type buttons
            document.getElementById('contractedBtn').addEventListener('click', function() {
                currentState.laborType = 'contracted';
                document.getElementById('contractedBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white';
                document.getElementById('hourlyBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('contractedInput').classList.remove('hidden');
                document.getElementById('hourlyInput').classList.add('hidden');
                calculateResults();
            });

            document.getElementById('hourlyBtn').addEventListener('click', function() {
                currentState.laborType = 'hourly';
                document.getElementById('hourlyBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white';
                document.getElementById('contractedBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('hourlyInput').classList.remove('hidden');
                document.getElementById('contractedInput').classList.add('hidden');
                calculateResults();
            });

            // Customer type buttons
            document.getElementById('customerBtn').addEventListener('click', function() {
                currentState.customerType = 'customer';
                document.getElementById('customerBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-green-600 text-white';
                document.getElementById('dealerBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                calculateResults();
            });

            document.getElementById('dealerBtn').addEventListener('click', function() {
                currentState.customerType = 'dealer';
                document.getElementById('dealerBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-green-600 text-white';
                document.getElementById('customerBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                calculateResults();
            });

            // Sales type buttons
            document.getElementById('inboundBtn').addEventListener('click', function() {
                currentState.salesType = 'inbound';
                document.getElementById('inboundBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white';
                document.getElementById('outboundBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('directBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                updateCommissionInput();
                calculateResults();
            });

            document.getElementById('outboundBtn').addEventListener('click', function() {
                currentState.salesType = 'outbound';
                document.getElementById('outboundBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white';
                document.getElementById('inboundBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('directBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                updateCommissionInput();
                calculateResults();
            });

            document.getElementById('directBtn').addEventListener('click', function() {
                currentState.salesType = 'direct';
                document.getElementById('directBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white';
                document.getElementById('inboundBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('outboundBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                updateCommissionInput();
                calculateResults();
            });

            // Commission rate change
            document.getElementById('commissionRate').addEventListener('change', function() {
                currentState.commissionRate = parseFloat(this.value) || 0;
                calculateResults();
            });

            // Dealer volume checkbox
            document.getElementById('dealerVolume').addEventListener('change', function() {
                currentState.dealerVolume = this.checked;
                calculateResults();
            });

            // Settings popup
            document.getElementById('settingsBtn').addEventListener('click', openSettings);
            document.getElementById('closeSettings').addEventListener('click', closeSettings);
            document.getElementById('cancelSettings').addEventListener('click', closeSettings);
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            document.getElementById('addPpfMaterial').addEventListener('click', addPpfMaterial);
            document.getElementById('exportSettings').addEventListener('click', exportSettings);
            document.getElementById('importSettings').addEventListener('click', importSettings);

            // Input changes
            const inputs = ['rollsNeeded', 'daysNeeded', 'contractedCost', 'hourlyRate', 'hoursNeeded', 'roundStep', 'taxPct', 'depositPct', 'commissionRate'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', calculateResults);
            });

            // Copy button
            document.getElementById('copyBtn').addEventListener('click', async function() {
                const quote = generateQuote();
                try {
                    await navigator.clipboard.writeText(quote);
                    alert('Quote copied to clipboard!');
                } catch {
                    const ta = document.createElement('textarea');
                    ta.value = quote;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    alert('Quote copied to clipboard!');
                }
            });

            // Reset button
            document.getElementById('resetBtn').addEventListener('click', function() {
                document.getElementById('vehicleType').value = 'car';
                document.getElementById('serviceType').value = 'full-front';
                document.getElementById('rollsNeeded').value = 0.7;
                document.getElementById('daysNeeded').value = 1.5;
                document.getElementById('contractedCost').value = 2000;
                document.getElementById('hourlyRate').value = 75;
                document.getElementById('hoursNeeded').value = 26;
                document.getElementById('taxPct').value = 0;
                document.getElementById('depositPct').value = 0;
                document.getElementById('roundStep').value = 0;
                
                // Reset buttons
                currentState = {
                    vehicleType: 'car',
                    serviceType: 'full-front',
                    ppfType: 'gloss',
                    laborType: 'contracted',
                    customerType: 'customer',
                    roundStep: 0,
                    salesType: 'inbound',
                    commissionRate: 0.04,
                    dealerVolume: false
                };
                
                // Reset button styles
                document.getElementById('glossBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white';
                document.getElementById('stealthBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('contractedBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white';
                document.getElementById('hourlyBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('customerBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-green-600 text-white';
                document.getElementById('dealerBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('inboundBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-blue-600 text-white';
                document.getElementById('outboundBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                document.getElementById('directBtn').className = 'flex-1 px-3 py-2 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300';
                
                document.getElementById('contractedInput').classList.remove('hidden');
                document.getElementById('hourlyInput').classList.add('hidden');
                document.getElementById('dealerVolume').checked = false;
                
                updateServiceInfo();
                updateCommissionInput();
                calculateResults();
            });
        }

        // Generate quote
        function generateQuote() {
            const vehicleType = document.getElementById('vehicleType');
            const serviceType = document.getElementById('serviceType');
            const vehicleLabel = vehicleType.options[vehicleType.selectedIndex].text;
            const serviceLabel = serviceType.options[serviceType.selectedIndex].text;
            
            return `Spectrum Outfitters ‚Äî PPF Quote
--------------------------------
Vehicle: ${vehicleLabel}
Service: ${serviceLabel}
PPF: ${currentState.ppfType === 'stealth' ? 'Stealth ($1,100/roll)' : 'Gloss ($800/roll)'}
Customer Type: ${currentState.customerType === 'dealer' ? 'Dealer (15% off retail)' : 'Retail'}

Costs
  Materials: ${document.getElementById('materialsCost').textContent}
  Labor: ${document.getElementById('laborCost').textContent}
  Daily: ${document.getElementById('overheadCost').textContent}
  Total Cost: ${document.getElementById('totalCost').textContent}

Quoted
  Final Price: ${document.getElementById('finalPrice').textContent}
  Margin: ${document.getElementById('marginDisplay').textContent}

---
spectrumoutfitters.com
Professional PPF Installation Services`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSettingsFromStorage(); // Load saved settings first
            setupEventHandlers();
            updateServiceInfo();
            updateCommissionInput();
            updatePpfTypeDropdown();
            calculateResults();
        });
    </script>
</body>
</html>
